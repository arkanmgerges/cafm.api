FROM python:3.8-slim

RUN apt update
RUN pip3 install --upgrade pip && pip3 install pipenv && pip3 install hupper

# -- Adding Pipfiles
COPY Pipfile Pipfile.lock ./
# -- Install dependencies:
RUN set -ex && pipenv install --dev --deploy --system
COPY . /app

ENV CAFM_API_LOGGING=DEBUG
ENV CAFM_API_LOGGING_MAX_FILE_LINES=7
ENV OPEN_TELEMETRY_IS_RUNNING=True
ENV SECRET_TOKEN=1EACFC47-FFDD-4CB9-9C45-3A53998C1FA8
ENV CAFM_API_SERVICE_NAME='cafm.api'
ENV MESSAGE_BROKER_SERVERS='kafka:9092'
ENV KAFKA_PARTITIONS_COUNT_PER_TOPIC=1
ENV MESSAGE_SCHEMA_REGISTRY_URL='http://schema-registry:9001'
ENV CAFM_API_COMMAND_TOPIC='cafm.api.cmd'
ENV CAFM_API_RESPONSE_TOPIC='cafm.api.rsp'
ENV CAFM_API_CONSUMER_GROUP_RSP_NAME='cafm.api.consumer-group.rsp'
ENV CAFM_API_REDIS_HOST='redis'
ENV CAFM_API_REDIS_PORT=6379
ENV CAFM_API_REDIS_RSP_KEY_PREFIX='cafm.api.rsp'
ENV CAFM_API_REDIS_RSP_TOPIC_TTL_IN_SECONDS=172800
ENV CAFM_IDENTITY_GRPC_SERVER_SERVICE='cafm-identity-server'
ENV CAFM_IDENTITY_GRPC_SERVER_SERVICE_PORT=9999
ENV CAFM_PROJECT_GRPC_SERVER_SERVICE='cafm-project-server'
ENV CAFM_PROJECT_GRPC_SERVER_SERVICE_PORT=9999
ENV CAFM_IDENTITY_REDIS_SESSION_KEY_PREFIX='cafm.identity.session.'
ENV CAFM_IDENTITY_USER_AUTH_TTL_IN_SECONDS=3600
ENV JAEGER_HOST=jaeger
ENV JAEGER_THRIFT_AGENT_PORT=6831
ENV ENABLE_CORS=True
ENV MICROSERVICES='identity:project'

